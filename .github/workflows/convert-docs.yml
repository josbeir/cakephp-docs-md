name: Convert CakePHP Documentation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      pandoc_version:
        description: 'Pandoc version to use (e.g., 3.3, 3.8, latest)'
        required: false
        default: '3.3' # Seems like < 3.3 is not working for us, especially for tables.
        type: string

jobs:
  convert-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CI: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y rsync python3 parallel

        # Install pandoc (configurable version)
        PANDOC_VERSION="${{ github.event.inputs.pandoc_version || '3.3' }}"
        echo "Installing Pandoc version: $PANDOC_VERSION"
        wget https://github.com/jgm/pandoc/releases/download/${PANDOC_VERSION}/pandoc-${PANDOC_VERSION}-linux-amd64.tar.gz
        tar xzf pandoc-${PANDOC_VERSION}-linux-amd64.tar.gz
        sudo cp pandoc-${PANDOC_VERSION}/bin/pandoc /usr/local/bin/

        # Verify installations
        pandoc --version
        python3 --version

    - name: Set up Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Make convert_branches executable
      run: chmod +x ./convert_branches

    - name: Run documentation conversion
      run: ./convert_branches --quiet

    - name: Clean up temp files and check for changes
      id: check_changes
      run: |
        # Remove any temp directories that might have been created
        find docs/ -name "temp" -type d -exec rm -rf {} + 2>/dev/null || true
        find docs/ -name "*.tmp" -type f -delete 2>/dev/null || true

        if [ -n "$(git status --porcelain docs/)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in docs/ folder"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in docs/ folder"
        fi

    - name: Commit and push changes to source repo
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git add docs/
        git commit -m "Update documentation from CakePHP docs branches

        ðŸ¤– Generated with GitHub Actions

        Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
        git push

    - name: Checkout CakePHP docs repository
      if: steps.check_changes.outputs.changes == 'true'
      uses: actions/checkout@v5
      with:
        repository: cakephp/docs
        ref: 5.x-vitepress
        path: cakephp-docs
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Sync docs to CakePHP repository
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # Use rsync to sync only changed folders from /docs to /docs in the target repo
        # --archive preserves permissions, timestamps, etc.
        # --update only copies files that are newer in the source
        # --exclude protects files we don't want to touch
        rsync -av --update \
          --exclude='.git*' \
          --exclude='README.md' \
          --exclude='*.log' \
          --exclude='public/' \
          docs/ cakephp-docs/docs/

    - name: Commit and push to CakePHP docs repository
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        cd cakephp-docs
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if there are any changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "Sync documentation updates from cakephp-docs-md

          ðŸ¤– Generated with GitHub Actions from $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          git push origin 5.x-vitepress
          echo "âœ… Successfully synced changes to CakePHP docs repository"
        else
          echo "â„¹ï¸ No changes to sync to CakePHP docs repository"
        fi

    - name: Create summary
      run: |
        echo "## Documentation Conversion Summary" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "âœ… Documentation updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes made:" >> $GITHUB_STEP_SUMMARY
          git show --stat HEAD >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes detected - documentation is up to date" >> $GITHUB_STEP_SUMMARY
        fi